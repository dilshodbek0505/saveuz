{% extends "admin/base_site.html" %}

{% block title %}Bulk product qo'shish{% endblock %}

{% block extrastyle %}
<style>
  :root {
    --primary: #6366f1;
    --primary-dark: #4f46e5;
    --primary-light: #a5b4fc;
    --success: #34d399;
    --danger: #f87171;
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-400: #9ca3af;
    --gray-600: #6b7280;
    --gray-700: #374151;
    --gray-800: #1f2937;
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 2px 4px 0 rgba(0, 0, 0, 0.06);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }

  * {
    box-sizing: border-box;
  }

  .bulk-wrapper {
    max-width: 1400px;
    margin: 0 auto;
    padding: 24px;
  }

  .bulk-wrapper h1 {
    font-size: 28px;
    font-weight: 700;
    color: var(--gray-800);
    margin-bottom: 8px;
  }

  .bulk-wrapper > p {
    color: var(--gray-600);
    font-size: 15px;
    margin-bottom: 24px;
    line-height: 1.6;
  }

  /* Messages */
  .messagelist {
    margin-bottom: 20px;
  }

  .messagelist .alert {
    padding: 14px 20px;
    border-radius: 8px;
    border-left: 4px solid;
    background: white;
    box-shadow: var(--shadow);
    font-size: 14px;
    font-weight: 500;
  }

  .messagelist .alert.success {
    border-left-color: var(--success);
    background: #ecfdf5;
    color: #065f46;
  }

  .messagelist .alert.error {
    border-left-color: var(--danger);
    background: #fef2f2;
    color: #991b1b;
  }

  /* Table Container */
  .table-container {
    background: white;
    border-radius: 8px;
    box-shadow: var(--shadow);
    overflow: hidden;
    margin-bottom: 24px;
    border: 1px solid var(--gray-200);
  }

  .table-scroll {
    overflow-x: auto;
    max-height: 70vh;
    overflow-y: auto;
  }

  .table-scroll::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }

  .table-scroll::-webkit-scrollbar-track {
    background: var(--gray-100);
  }

  .table-scroll::-webkit-scrollbar-thumb {
    background: var(--gray-400);
    border-radius: 4px;
  }

  /* Table */
  .bulk-table {
    width: 100%;
    min-width: 1200px;
    border-collapse: separate;
    border-spacing: 0;
    background-color: #fff;
  }

  .bulk-table thead {
    position: sticky;
    top: 0;
    z-index: 10;
    background: var(--primary);
  }

  .bulk-table th {
    padding: 16px 12px;
    text-align: center;
    font-weight: 600;
    font-size: 13px;
    color: white;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 2px solid var(--primary-dark);
  }

  .bulk-table tbody tr {
    border-bottom: 1px solid var(--gray-200);
  }

  .bulk-table td {
    padding: 12px;
    vertical-align: middle;
    font-size: 14px;
    color: var(--gray-700);
    text-align: center;
  }

  /* Form Inputs */
  .bulk-input,
  .bulk-table input[type="text"],
  .bulk-table input[type="number"],
  .bulk-table textarea,
  .bulk-table select {
    width: 100%;
    padding: 10px 12px;
    border: 2px solid var(--gray-300);
    border-radius: 6px;
    font-size: 14px;
    background: white;
    color: var(--gray-800);
    text-align: center;
  }

  .bulk-input:focus,
  .bulk-table input:focus,
  .bulk-table textarea:focus,
  .bulk-table select:focus {
    outline: none;
    border-color: var(--primary);
  }

  .bulk-table textarea.bulk-input {
    resize: vertical;
    min-height: 80px;
    font-family: inherit;
    text-align: left;
  }

  /* Image Field */
  .image-field {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
  }

  .image-field input[type="file"] {
    display: none;
  }

  .thumb-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
    gap: 8px;
    width: 180px;
  }

  .thumb {
    width: 100%;
    padding-top: 100%;
    position: relative;
    border: 2px solid var(--gray-300);
    border-radius: 8px;
    background: var(--gray-50);
    overflow: hidden;
  }

  .thumb img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .thumb-placeholder {
    color: var(--gray-400);
    font-size: 14px;
    text-align: center;
    padding: 8px;
    font-weight: 500;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 8px;
    position: absolute;
    inset: 0;
  }

  .thumb-placeholder svg {
    width: 40px;
    height: 40px;
    color: var(--gray-400);
  }

  .upload-btn {
    padding: 8px 16px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .upload-btn svg {
    width: 16px;
    height: 16px;
  }

  .hidden {
    display: none;
  }

  .image-counter {
    font-size: 12px;
    color: var(--gray-500);
  }

  /* Error Messages */
  .form-error {
    color: var(--danger);
    font-size: 12px;
    margin-top: 6px;
    font-weight: 500;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
  }

  .form-error::before {
    content: "âš ";
    font-size: 14px;
  }

  /* Buttons */
  .button {
    padding: 10px 24px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    box-shadow: var(--shadow-sm);
  }

  #add-product-row {
    background: white;
    color: var(--primary);
    border: 2px solid var(--primary);
    font-size: 13px;
    padding: 8px 16px;
  }

  #add-product-row svg {
    width: 16px;
    height: 16px;
  }

  .button-primary {
    background: var(--primary);
    color: white;
    padding: 12px 32px;
    font-size: 15px;
  }

  .button-primary svg {
    width: 18px;
    height: 18px;
  }

  /* Actions Bar */
  .actions {
    display: flex;
    justify-content: flex-end;
    gap: 16px;
    padding: 20px 0;
  }

  /* Loading Spinner */
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }

  .loading-overlay.active {
    display: flex;
  }

  .spinner {
    width: 50px;
    height: 50px;
    border: 4px solid var(--gray-200);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Responsive */
  @media (max-width: 768px) {
    .bulk-wrapper {
      padding: 16px;
    }

    .bulk-wrapper h1 {
      font-size: 24px;
    }

    .actions {
      flex-direction: column;
    }

    .button {
      width: 100%;
      justify-content: center;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="bulk-wrapper">
  <h1>Bir martada mahsulot qo'shish</h1>
  <p>Ko'p mahsulotlarni jadval orqali to'ldiring va bir marta saqlang. Rasm maydoni ixtiyoriy.</p>

  {% if messages %}
    {% for message in messages %}
      <div class="messagelist">
        <div class="alert {{ message.tags }}">{{ message }}</div>
      </div>
    {% endfor %}
  {% endif %}

  <form method="post" enctype="multipart/form-data" novalidate id="bulk-form">
    {% csrf_token %}
    {{ formset.management_form }}
    {% if formset.non_form_errors %}
      <div class="form-error">
        {% for error in formset.non_form_errors %}
          <div>{{ error }}</div>
        {% endfor %}
      </div>
    {% endif %}

    <div class="table-container">
      <div class="table-scroll">
        <table class="bulk-table">
          <thead>
            <tr>
              <th>Mahsulot nomi</th>
              <th>Narx</th>
              <th>Ta'rif</th>
              <th>Rasm</th>
              <th>Market</th>
              <th>Kategoriya</th>
              <th>Chegirma narxi</th>
              <th>Chegirma turi</th>
              <th>Chegirma qiymati</th>
            </tr>
          </thead>
          <tbody id="product-form-rows">
            {% for form in formset.forms %}
            <tr class="product-row" data-form-index="{{ forloop.counter0 }}">
              <td>
                {% for hidden_field in form.hidden_fields %}
                  {{ hidden_field }}
                {% endfor %}
                {% if form.non_field_errors %}
                  {% for error in form.non_field_errors %}
                    <div class="form-error">{{ error }}</div>
                  {% endfor %}
                {% endif %}
                {{ form.name }}
                {% for error in form.name.errors %}
                  <div class="form-error">{{ error }}</div>
                {% endfor %}
              </td>
              <td>
                {{ form.price }}
                {% for error in form.price.errors %}
                  <div class="form-error">{{ error }}</div>
                {% endfor %}
              </td>
              <td>
                {{ form.description }}
                {% for error in form.description.errors %}
                  <div class="form-error">{{ error }}</div>
                {% endfor %}
              </td>
              <td>
                <div class="image-field" data-role="image-field">
                  <div class="thumb-grid" data-role="thumb-grid">
                    {% if form.instance.pk %}
                      {% with existing=form.instance.images.all %}
                        {% if existing %}
                          {% for product_image in existing %}
                            <div class="thumb">
                              <img src="{{ product_image.image.url }}" alt="Mahsulot rasmi">
                            </div>
                          {% endfor %}
                        {% else %}
                          <div class="thumb thumb-placeholder" data-role="thumb-placeholder">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <span>Rasmlar yuklash</span>
                          </div>
                        {% endif %}
                      {% endwith %}
                    {% else %}
                      <div class="thumb thumb-placeholder" data-role="thumb-placeholder">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <span>Rasmlar yuklash</span>
                      </div>
                    {% endif %}
                  </div>
                  <button type="button" class="upload-btn" data-role="upload-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    Rasmlar yuklash
                  </button>
                  <div class="image-counter" data-role="image-counter">
                    {% if form.instance.pk %}
                      {% with count=form.instance.images.count %}
                        {% if count %}
                          {{ count }} ta rasm mavjud
                        {% else %}
                          Rasm tanlanmadi
                        {% endif %}
                      {% endwith %}
                    {% else %}
                      Rasm tanlanmadi
                    {% endif %}
                  </div>
                  {{ form.images }}
                </div>
                {% for error in form.images.errors %}
                  <div class="form-error">{{ error }}</div>
                {% endfor %}
              </td>
              <td>
                {{ form.market }}
                {% for error in form.market.errors %}
                  <div class="form-error">{{ error }}</div>
                {% endfor %}
              </td>
              <td>
                {{ form.category }}
                {% for error in form.category.errors %}
                  <div class="form-error">{{ error }}</div>
                {% endfor %}
              </td>
              <td>
                {{ form.discount_price }}
                {% for error in form.discount_price.errors %}
                  <div class="form-error">{{ error }}</div>
                {% endfor %}
              </td>
              <td>
                {{ form.discount_type }}
                {% for error in form.discount_type.errors %}
                  <div class="form-error">{{ error }}</div>
                {% endfor %}
              </td>
              <td>
                {{ form.discount_value }}
                {% for error in form.discount_value.errors %}
                  <div class="form-error">{{ error }}</div>
                {% endfor %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="actions">
      <button type="button" class="button" id="add-product-row">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        Qator qo'shish
      </button>
      <button type="submit" class="button button-primary">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
        Saqlash
      </button>
    </div>
  </form>
</div>

<div class="loading-overlay" id="loading-overlay">
  <div class="spinner"></div>
</div>

<template id="empty-row-template">
  <tr class="product-row" data-form-index="__prefix__">
    <td>
      {% for hidden_field in formset.empty_form.hidden_fields %}
        {{ hidden_field.as_widget }}
      {% endfor %}
      {{ formset.empty_form.name }}
    </td>
    <td>
      {{ formset.empty_form.price }}
    </td>
    <td>
      {{ formset.empty_form.description }}
    </td>
    <td>
      <div class="image-field" data-role="image-field">
        <div class="thumb-grid" data-role="thumb-grid">
          <div class="thumb thumb-placeholder" data-role="thumb-placeholder">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            <span>Rasmlar yuklash</span>
          </div>
        </div>
        <button type="button" class="upload-btn" data-role="upload-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          Rasmlar yuklash
        </button>
        <div class="image-counter" data-role="image-counter">Rasm tanlanmadi</div>
        {{ formset.empty_form.images }}
      </div>
    </td>
    <td>
      {{ formset.empty_form.market }}
    </td>
    <td>
      {{ formset.empty_form.category }}
    </td>
    <td>
      {{ formset.empty_form.discount_price }}
    </td>
    <td>
      {{ formset.empty_form.discount_type }}
    </td>
    <td>
      {{ formset.empty_form.discount_value }}
    </td>
  </tr>
</template>

<script>
(function () {
  const rowsContainer = document.getElementById("product-form-rows");
  const addButton = document.getElementById("add-product-row");
  const template = document.getElementById("empty-row-template");
  const totalFormsInput = document.getElementById("id_{{ view.formset_prefix }}-TOTAL_FORMS");
  const form = document.getElementById("bulk-form");
  const loadingOverlay = document.getElementById("loading-overlay");

  if (!rowsContainer || !addButton || !template || !totalFormsInput) {
    return;
  }

  const previewUrlCache = new WeakMap();

  function clearPreviewUrls(row) {
    const urls = previewUrlCache.get(row) || [];
    urls.forEach((url) => URL.revokeObjectURL(url));
    previewUrlCache.set(row, []);
  }

  function renderImagePreviews(row, files) {
    const grid = row.querySelector('[data-role="thumb-grid"]');
    const placeholder = row.querySelector('[data-role="thumb-placeholder"]');
    const counter = row.querySelector('[data-role="image-counter"]');

    if (!grid) {
      return;
    }

    clearPreviewUrls(row);
    grid.querySelectorAll('[data-preview="1"]').forEach((node) => node.remove());

    if (!files.length) {
      if (placeholder) {
        placeholder.classList.remove("hidden");
      }
      if (counter) {
        counter.textContent = "Rasm tanlanmadi";
      }
      return;
    }

    if (placeholder) {
      placeholder.classList.add("hidden");
    }
    if (counter) {
      counter.textContent = `${files.length} ta rasm tanlandi`;
    }

    const urls = [];
    const fragment = document.createDocumentFragment();

    files.forEach((file) => {
      const thumb = document.createElement("div");
      thumb.className = "thumb";
      thumb.dataset.preview = "1";

      const img = document.createElement("img");
      const objectUrl = URL.createObjectURL(file);
      img.src = objectUrl;
      urls.push(objectUrl);

      thumb.appendChild(img);
      fragment.appendChild(thumb);
    });

    grid.appendChild(fragment);
    previewUrlCache.set(row, urls);
  }

  function setupImagePreview(row) {
    const fileInput = row.querySelector('[data-role="image-input"]');
    const trigger = row.querySelector('[data-role="upload-trigger"]');

    if (!fileInput || !trigger) {
      return;
    }

    trigger.addEventListener("click", function () {
      fileInput.click();
    });

    fileInput.addEventListener("change", function () {
      const files = Array.from(fileInput.files || []);
      renderImagePreviews(row, files);
    });
  }

  // Setup row
  function setupRow(row) {
    previewUrlCache.set(row, []);
    setupImagePreview(row);
  }

  // Add new row
  addButton.addEventListener("click", function () {
    const currentIndex = parseInt(totalFormsInput.value, 10);
    const newRowHtml = template.innerHTML.replace(/__prefix__/g, currentIndex);
    const fragment = document.createElement("template");
    fragment.innerHTML = newRowHtml.trim();
    const newRow = fragment.content.firstElementChild;

    if (!newRow) return;

    rowsContainer.appendChild(newRow);
    totalFormsInput.value = currentIndex + 1;
    setupRow(newRow);

    // Scroll to new row
    setTimeout(() => {
      newRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 100);
  });

  // Form submission
  form.addEventListener("submit", function() {
    loadingOverlay.classList.add("active");
  });

  // Initialize existing rows
  Array.prototype.forEach.call(rowsContainer.querySelectorAll(".product-row"), setupRow);
})();
</script>
{% endblock %}
